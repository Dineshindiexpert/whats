<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WhatsApp-like Chat</title>

    <!-- Bootstrap for helpers -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #25D366;
            --accent: #075E54;
            --bg: #f0f2f5;
            --left-bubble: #dcf8c6;
            --right-bubble: #fff;
            --muted: #667085;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            font-family: "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            height: 100%;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-wrap {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: 100%;
            max-width: 320px;
            background: #fff;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(0, 0, 0, .08);
        }

        .sidebar-header {
            padding: .8rem;
            display: flex;
            align-items: center;
            gap: .8rem;
            background: var(--accent);
            color: #fff;
        }

        .search-bar {
            padding: .6rem;
            border-bottom: 1px solid rgba(0, 0, 0, .05);
            background: #f6f6f6;
        }

        .search-bar input {
            width: 100%;
            border-radius: 20px;
            padding: .5rem 1rem;
            border: 0;
            background: #fff;
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
        }

        .userItem {
            display: flex;
            align-items: center;
            gap: .8rem;
            padding: .8rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, .03);
            transition: background .2s;
        }

        .userItem:hover {
            background: #f6f6f6;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--accent);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: .4rem;
        }

        .status-online {
            background: var(--primary);
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            min-height: 0;
        }

        .chat-header {
            height: 60px;
            display: flex;
            align-items: center;
            gap: .8rem;
            padding: .6rem 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, .08);
            background: var(--accent);
            color: #fff;
            font-weight: 500;
        }

        .chat-header .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fff;
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: .6rem;
        }

        .msg-row {
            display: flex;
        }

        .msg-row.send {
            justify-content: flex-end;
        }

        .msg-row.recv {
            justify-content: flex-start;
        }

        .bubble {
            max-width: 75%;
            padding: .5rem .7rem;
            border-radius: 10px;
            font-size: .95rem;
            line-height: 1.3;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .1);
            word-wrap: break-word;
            background: var(--right-bubble);
        }

        .bubble-send {
            background: var(--left-bubble);
            border-bottom-right-radius: 2px;
        }

        .bubble-recv {
            background: var(--right-bubble);
            border-bottom-left-radius: 2px;
        }

        .meta-info {
            display: flex;
            justify-content: flex-end;
            font-size: .7rem;
            color: var(--muted);
            margin-top: 2px;
        }

        .composer {
            flex-shrink: 0;
            padding: .6rem;
            display: flex;
            gap: .6rem;
            align-items: flex-end;
            border-top: 1px solid rgba(0, 0, 0, .08);
            background: #fff;
        }

        .composer .input {
            flex: 1;
            display: flex;
            gap: .5rem;
            align-items: center;
            background: #f6f6f6;
            border-radius: 24px;
            padding: .4rem .6rem;
            border: 1px solid rgba(0, 0, 0, .1);
        }

        .composer textarea {
            width: 100%;
            border: 0;
            resize: none;
            height: 40px;
            padding: .25rem;
            font-size: 1rem;
            border-radius: 8px;
            outline: none;
            background: transparent;
        }

        .icon-btn,
        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 0;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background .2s;
        }

        .send-btn {
            background: var(--primary);
            color: #fff;
            width: 44px;
            height: 44px;
        }

        .icon-btn:hover {
            background: rgba(0, 0, 0, .05);
        }

        .media-thumb {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 4px;
        }

        /* Mobile first */
        @media(max-width:768px) {
            .chat-wrap {
                flex-direction: column;
                height: 100vh;
            }

            .sidebar {
                max-width: 100%;
                height: 35vh;
            }

            .chat-area {
                flex: 1;
            }

            .messages {
                flex: 1;
            }
        }
    </style>

</head>

<body>

    <div class="app">
        <div class="chat-wrap">

            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div
                        style="width:40px;height:40px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;">
                        <strong style="color:#075E54">WS</strong>
                    </div>
                    <div style="flex:1">
                        <div style="font-weight:700">Chat App</div>
                        <div style="font-size:.85rem;opacity:.9">Signed in</div>
                    </div>
                    <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
                </div>

                <div class="search-bar">
                    <input id="searchUser" placeholder="Search or start new chat">
                </div>

                <div class="user-list" id="userList">
                    <div class="p-3 text-center text-muted">Loading users...</div>
                </div>
            </aside>

            <!-- Chat area -->
            <section class="chat-area">
                <div class="chat-header">
                    <div class="avatar" id="chatAvatar">U</div>
                    <div class="meta">
                        <div id="chatName">Select a user</div>
                        <small id="chatStatus">No chat selected</small>
                    </div>
                </div>

                <div class="messages" id="chatBox">
                    <div class="text-center muted">Select a user to start chat</div>
                </div>

                <div class="composer">
                    <div class="input">
                        <button class="icon-btn" id="emojiBtn">ğŸ˜Š</button>
                        <textarea id="msgInput" placeholder="Type a message"></textarea>
                        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none">
                        <button class="icon-btn" id="attachBtn">ğŸ“</button>
                    </div>
                    <button class="send-btn" id="sendBtn">â¤</button>
                </div>
            </section>

        </div>
    </div>

    <div id="emojiPanel"
        style="position:fixed;bottom:80px;left:16px;background:#fff;border-radius:8px;padding:8px;display:none;box-shadow:0 6px 18px rgba(0,0,0,.12);z-index:999">
        <div style="display:flex;flex-wrap:wrap;gap:6px;max-width:320px;max-height:180px;overflow:auto;">
            ğŸ˜Š ğŸ˜‚ ğŸ˜ ğŸ˜˜ ğŸ˜… ğŸ¤£ ğŸ‘ ğŸ‘ ğŸ™ ğŸ‰ ğŸ˜­ ğŸ˜´ ğŸ˜¡ ğŸ¤— ğŸ˜ ğŸ˜‡ ğŸ’¯ ğŸ”¥ â¤ï¸ ğŸ’™ ğŸ¥² ğŸ¥³ ğŸ¤ ğŸ¥º ğŸ¤”
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, push, get, child, onDisconnect, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDEPxzueUia3bqkXIrWB_4xF_qOh5ZvAjI",
            authDomain: "chatapp-9a742.firebaseapp.com",
            databaseURL: "https://chatapp-9a742-default-rtdb.firebaseio.com",
            projectId: "chatapp-9a742",
            storageBucket: "chatapp-9a742.appspot.com",
            messagingSenderId: "384469214707",
            appId: "1:384469214707:web:ac32854938b240e14c5e86"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth();
        const storage = getStorage(app);

        let currentUser = null;
        let selectedUser = null;
        let messagesUnsub = null;

        const userListEl = document.getElementById('userList');
        const chatBox = document.getElementById('chatBox');
        const chatName = document.getElementById('chatName');
        const chatStatus = document.getElementById('chatStatus');
        const chatAvatar = document.getElementById('chatAvatar');
        const msgInput = document.getElementById('msgInput');
        const fileInput = document.getElementById('fileInput');
        const logoutBtn = document.getElementById('logoutBtn');

        function el(html) { const tmp = document.createElement('div'); tmp.innerHTML = html; return tmp.firstElementChild; }
        function formatTime(ts) { const d = new Date(ts); return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0'); }

        // --- Auth state
        onAuthStateChanged(auth, (user) => {
            if (!user) { alert('Please login first'); return; }
            currentUser = user.uid;
            set(ref(db, 'status/' + currentUser), 'online');
            onDisconnect(ref(db, 'status/' + currentUser)).set('offline');
            ensureUserProfile();
            loadUserList();
            listenTyping();
        });

        // --- Ensure user profile exists
        function ensureUserProfile() {
            const profileRef = ref(db, 'users/' + currentUser);
            get(profileRef).then(snap => { if (!snap.exists()) set(profileRef, { name: 'User_' + currentUser.slice(-5) }); });
        }

        // --- Load user list
        function loadUserList() {
            onValue(ref(db, 'status'), (snap) => {
                const users = snap.val() || {};
                get(child(ref(db), 'users')).then(usersSnap => {
                    const usersMeta = usersSnap.val() || {};
                    let html = '';
                    for (let uid in users) {
                        if (uid === currentUser) continue;
                        const meta = usersMeta[uid] || { name: uid };
                        html += `<div class="userItem" data-id="${uid}">
                            <div class="user-avatar">${(meta.name || 'U').charAt(0).toUpperCase()}</div>
                            <div style="flex:1" class="user-meta"><strong>${meta.name || uid}</strong>
                            <small class="${users[uid] === 'online' ? 'text-success' : 'text-secondary'}">â— ${users[uid]}</small></div>
                            <div><span class="status-dot ${users[uid] === 'online' ? 'status-online' : ''}"></span></div>
                         </div>`;
                    }
                    userListEl.innerHTML = html || '<div class="p-3 text-muted">No other users</div>';
                    document.querySelectorAll('.userItem').forEach(el => el.onclick = () => { selectUser(el.dataset.id); });
                });
            });
        }

        // --- Select user and load messages
        function selectUser(uid) {
            selectedUser = uid;
            get(child(ref(db), 'users/' + uid)).then(snap => {
                const meta = snap.val() || {};
                chatName.innerText = meta.name || uid;
                chatAvatar.innerText = (meta.name || uid).charAt(0).toUpperCase();
            });

            onValue(ref(db, 'status/' + uid), (s) => chatStatus.innerText = s.val() || 'offline');

            chatBox.innerHTML = '<div class="text-center muted">Loading messages...</div>';
            if (messagesUnsub) off(ref(db, `messages/${currentUser}/${selectedUser}`), 'value', messagesUnsub);
            messagesUnsub = (snap) => renderMessages(snap.val() || {});
            onValue(ref(db, `messages/${currentUser}/${selectedUser}`), messagesUnsub);

            onValue(ref(db, `messages/${selectedUser}/${currentUser}`), (snap) => {
                const data = snap.val() || {};
                for (let key in data) {
                    const m = data[key];
                    if (m && m.status !== 'seen' && m.sender === selectedUser) {
                        update(ref(db, `messages/${selectedUser}/${currentUser}/${key}`), { status: 'seen' });
                        update(ref(db, `messages/${currentUser}/${selectedUser}/${key}`), { status: 'seen' });
                    }
                }
            });
        }

        // --- Render messages
        function renderMessages(data) {
            const entries = Object.entries(data || {}).sort((a, b) => (a[1].time || 0) - (b[1].time || 0));
            chatBox.innerHTML = '';
            entries.forEach(([key, m]) => {
                if (!m) return;
                const isSender = (m.sender === currentUser);
                const row = document.createElement('div'); row.className = 'msg-row ' + (isSender ? 'send' : 'recv');
                const bubble = document.createElement('div'); bubble.className = 'bubble ' + (isSender ? 'bubble-send' : 'bubble-recv');
                if (m.type === 'image' || m.type === 'video') {
                    const tag = document.createElement(m.type === 'image' ? 'img' : 'video');
                    tag.className = 'media-thumb';
                    tag.src = m.mediaURL;
                    if (m.type === 'video') tag.controls = true;
                    bubble.appendChild(tag);
                }
                if (m.text) {
                    const p = document.createElement('div'); p.innerText = m.text;
                    bubble.appendChild(p);
                }
                const meta = document.createElement('div'); meta.className = 'meta-info';
                const timeSpan = document.createElement('span'); timeSpan.className = 'time'; timeSpan.innerText = formatTime(m.time || Date.now());
                meta.appendChild(timeSpan);
                if (isSender) {
                    const tick = document.createElement('span'); tick.className = 'tick';
                    if (m.status === 'seen') tick.innerHTML = 'âœ”âœ”';
                    else if (m.status === 'delivered') { tick.innerHTML = 'âœ”âœ”'; tick.classList.add('delivered'); }
                    else tick.innerHTML = 'âœ”';
                    meta.appendChild(tick);
                }
                bubble.appendChild(meta);
                row.appendChild(bubble);
                chatBox.appendChild(row);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- Send messages
        document.getElementById('sendBtn').onclick = sendMessage;
        msgInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

        function sendMessage() {
            const text = msgInput.value.trim();
            if (!text || !selectedUser) return;

            const time = Date.now();
            const msg = { sender: currentUser, text, time: time, status: 'delivered' };

            // Dono users ke path me message bhejna
            const senderRef = ref(db, `messages/${currentUser}/${selectedUser}`);
            const receiverRef = ref(db, `messages/${selectedUser}/${currentUser}`);

            const newKey = push(senderRef).key;  // unique key

            const updates = {};
            updates[newKey] = msg;

            // Pehle sender path
            update(senderRef, updates).then(() => {
                // Phir receiver path
                update(receiverRef, updates);
            }).catch(err => console.error('Send failed:', err));

            msgInput.value = '';
        }
        function pushMessage(msg) {
            const senderRef = ref(db, `messages/${currentUser}/${selectedUser}`);
            const receiverRef = ref(db, `messages/${selectedUser}/${currentUser}`);
            const key = push(senderRef).key;
            const updates = {};
            updates[key] = msg;
            update(senderRef, updates);
            update(receiverRef, updates);
        }


        // --- Attach button
        document.getElementById('attachBtn').onclick = () => fileInput.click();

        // --- Emoji picker
        const emojiPanel = document.getElementById('emojiPanel');
        document.getElementById('emojiBtn').onclick = () => {
            emojiPanel.style.display = emojiPanel.style.display === 'none' ? 'flex' : 'none';
        };
        emojiPanel.querySelectorAll('div span,div').forEach(e => {
            e.onclick = () => {
                msgInput.value += e.innerText;
                msgInput.focus();
            }
        });

        // --- Typing indicator
        function listenTyping() {
            msgInput.addEventListener('input', () => {
                if (!selectedUser) return;
                update(ref(db, `typing/${currentUser}/${selectedUser}`), { typing: msgInput.value.length > 0 });
                setTimeout(() => update(ref(db, `typing/${currentUser}/${selectedUser}`), { typing: false }), 3000);
            });
            onValue(ref(db, `typing/${selectedUser}/${currentUser}`), snap => {
                if (snap.val() && snap.val().typing) chatStatus.innerText = 'typing...';
                else onValue(ref(db, 'status/' + selectedUser), s => chatStatus.innerText = s.val() || 'offline');
            });
        }

        // --- Logout button
        logoutBtn.onclick = () => {
            if (confirm('Are you sure you want to logout?')) {
                signOut(auth).then(() => {
                    // Redirect to login page
                    window.location.href = 'index.html';
                }).catch(err => alert('Logout failed: ' + err.message));
            }
        };
        onValue(ref(db, 'status'), async (snap) => {
            const usersStatus = snap.val() || {};
            const usersSnap = await get(ref(db, 'users'));
            const usersData = usersSnap.val() || {};

            let html = '';
            for (let uid in usersStatus) {
                if (uid === currentUser) continue;          // apne aap ko skip karo
                if (!usersData[uid]) continue;             // deleted user skip karo

                const meta = usersData[uid];
                html += `<div class="userItem" data-id="${uid}">
                    <div class="user-avatar">${(meta.name || 'U').charAt(0).toUpperCase()}</div>
                    <div style="flex:1" class="user-meta">
                        <strong>${meta.name || uid}</strong>
                        <small class="${usersStatus[uid] === 'online' ? 'text-success' : 'text-secondary'}">â— ${usersStatus[uid]}</small>
                    </div>
                    <div><span class="status-dot ${usersStatus[uid] === 'online' ? 'status-online' : ''}"></span></div>
                 </div>`;
            }
            userListEl.innerHTML = html || '<div class="p-3 text-muted">No other users</div>';
        });

    </script>

</body>

</html>